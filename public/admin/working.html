<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Gelora Blog CMS - Working Version</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'JetBrains Mono', monospace;
      background: #000;
      color: #fff;
      margin: 0;
      padding: 20px;
      line-height: 1.6;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    .header {
      text-align: center;
      margin-bottom: 40px;
      padding-bottom: 20px;
      border-bottom: 1px solid #333;
    }
    .section {
      background: #1a1a1a;
      border: 1px solid #333;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
    }
    .btn {
      background: transparent;
      border: 1px solid #666;
      color: #fff;
      padding: 12px 24px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      margin: 5px;
      border-radius: 4px;
      transition: all 0.3s;
      font-family: inherit;
    }
    .btn:hover {
      background: #333;
      border-color: #4ade80;
    }
    .btn.primary {
      background: #4ade80;
      border-color: #4ade80;
      color: #000;
    }
    .btn.primary:hover {
      background: #22c55e;
    }
    .form-group {
      margin: 15px 0;
    }
    label {
      display: block;
      margin-bottom: 5px;
      color: #ccc;
    }
    input, textarea, select {
      width: 100%;
      padding: 10px;
      background: #333;
      border: 1px solid #666;
      color: #fff;
      border-radius: 4px;
      font-family: inherit;
    }
    textarea {
      min-height: 300px;
      resize: vertical;
    }
    .posts-list {
      display: grid;
      gap: 15px;
    }
    .post-item {
      background: #2a2a2a;
      padding: 15px;
      border: 1px solid #444;
      border-radius: 6px;
    }
    .post-title { font-weight: bold; margin-bottom: 5px; }
    .post-meta { font-size: 0.9em; color: #888; margin-bottom: 10px; }
    .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
    .status.success { background: #1a4a1a; border: 1px solid #4a7a4a; color: #4ade80; }
    .status.error { background: #4a1a1a; border: 1px solid #7a4a4a; color: #ef4444; }
    .status.info { background: #1a1a4a; border: 1px solid #4a4a7a; color: #3b82f6; }
    .hidden { display: none; }
    .tab-buttons { margin-bottom: 20px; }
    .tab-button {
      background: #333;
      border: 1px solid #666;
      color: #fff;
      padding: 10px 20px;
      cursor: pointer;
      margin-right: 5px;
      border-radius: 4px 4px 0 0;
    }
    .tab-button.active {
      background: #4ade80;
      color: #000;
      border-color: #4ade80;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Login Screen -->
    <div id="login-screen" class="section">
      <div class="header">
        <h1>üîê GELORA BLOG CMS</h1>
        <p>Admin Login Required</p>
      </div>
      
      <form id="login-form" onsubmit="login(event)" style="max-width: 400px; margin: 0 auto;">
        <div class="form-group">
          <label for="admin-password">Admin Password:</label>
          <input type="password" id="admin-password" name="password" required placeholder="Enter admin password">
        </div>
        <div class="form-group">
          <button type="submit" class="btn primary">üîì Login</button>
        </div>
        <div id="login-status"></div>
        <div style="margin-top: 20px; font-size: 0.9em; color: #888;">
          <p><strong>Security Notice:</strong> Only authorized administrators can access this CMS.</p>
          <p>Default password: <code>gelora2025</code> (change in Vercel env: ADMIN_PASSWORD)</p>
        </div>
      </form>
    </div>

    <!-- Main CMS (hidden by default) -->
    <div id="main-cms" class="hidden">
      <div class="header">
        <h1>üöÄ GELORA BLOG CMS</h1>
        <p>Content Management System</p>
        <button class="btn" onclick="logout()" style="float: right;">üîí Logout</button>
        <div style="clear: both;"></div>
      </div>

    <div class="tab-buttons">
      <button class="tab-button active" onclick="showTab('posts')">üìñ Posts</button>
      <button class="tab-button" onclick="showTab('create')">‚úçÔ∏è Create Post</button>
      <button class="tab-button" onclick="showTab('edit')" id="edit-tab-button" style="display: none;">‚úèÔ∏è Edit Post</button>
      <button class="tab-button" onclick="showTab('debug')">üîç Debug</button>
    </div>

    <!-- Posts Tab -->
    <div id="posts-tab" class="tab-content">
      <div class="section">
        <h2>üìñ Blog Posts</h2>
        <div id="posts-status" class="status info">Loading posts...</div>
        <div id="posts-list" class="posts-list"></div>
        <button class="btn" onclick="loadPosts()">üîÑ Refresh Posts</button>
      </div>
    </div>

    <!-- Create Post Tab -->
    <div id="create-tab" class="tab-content hidden">
      <div class="section">
        <h2>‚úçÔ∏è Create New Post</h2>
        <form id="create-form" onsubmit="createPost(event)">
          <div class="form-group">
            <label for="title">Title:</label>
            <input type="text" id="title" name="title" required>
          </div>
          <div class="form-group">
            <label for="summary">Summary:</label>
            <input type="text" id="summary" name="summary" required>
          </div>
          <div class="form-group">
            <label for="tags">Tags (comma separated):</label>
            <input type="text" id="tags" name="tags" value="ethereum" placeholder="ethereum, defi, protocol">
          </div>
          <div class="form-group">
            <label for="content">Content (Markdown):</label>
            <textarea id="content" name="content" placeholder="Write your post content here...&#10;&#10;## Example Heading&#10;&#10;Your content goes here." required></textarea>
          </div>
          <div class="form-group">
            <button type="submit" class="btn primary">üöÄ Publish Post</button>
            <button type="button" class="btn" onclick="clearForm()">üóëÔ∏è Clear Form</button>
          </div>
        </form>
        <div id="create-status"></div>
      </div>
    </div>

    <!-- Edit Post Tab -->
    <div id="edit-tab" class="tab-content hidden">
      <div class="section">
        <h2>‚úèÔ∏è Edit Post</h2>
        <form id="edit-form" onsubmit="updatePost(event)">
          <input type="hidden" id="edit-original-filename" name="originalFilename">
          <div class="form-group">
            <label for="edit-title">Title:</label>
            <input type="text" id="edit-title" name="title" required>
          </div>
          <div class="form-group">
            <label for="edit-summary">Summary:</label>
            <input type="text" id="edit-summary" name="summary" required>
          </div>
          <div class="form-group">
            <label for="edit-tags">Tags (comma separated):</label>
            <input type="text" id="edit-tags" name="tags">
          </div>
          <div class="form-group">
            <label for="edit-date">Date:</label>
            <input type="date" id="edit-date" name="date" required>
          </div>
          <div class="form-group">
            <label for="edit-content">Content (Markdown):</label>
            <textarea id="edit-content" name="content" required></textarea>
          </div>
          <div class="form-group">
            <button type="submit" class="btn primary">üíæ Update Post</button>
            <button type="button" class="btn" onclick="cancelEdit()">‚ùå Cancel</button>
          </div>
        </form>
        <div id="edit-status"></div>
      </div>
    </div>

    <!-- Debug Tab -->
    <div id="debug-tab" class="tab-content hidden">
      <div class="section">
        <h2>üîç System Debug</h2>
        <div id="debug-results">
          <div class="status info">Click "Run Tests" to check system status</div>
        </div>
        <button class="btn" onclick="runDebugTests()">üîß Run Tests</button>
        <button class="btn" onclick="window.open('/admin/debug.html', '_blank')">üìã Full Debug Page</button>
      </div>
    </div>
    </div>
  </div>

  <script>
    // Authentication
    let authToken = localStorage.getItem('gelora_admin_token');
    
    function login(event) {
      event.preventDefault();
      const password = document.getElementById('admin-password').value;
      const statusDiv = document.getElementById('login-status');
      
      // For simplicity, we'll use the password as the token
      authToken = password;
      
      statusDiv.innerHTML = '<div class="status info">Checking credentials...</div>';
      
      // Test the token by trying to fetch posts
      testAuth().then(success => {
        if (success) {
          localStorage.setItem('gelora_admin_token', authToken);
          document.getElementById('login-screen').style.display = 'none';
          document.getElementById('main-cms').classList.remove('hidden');
          statusDiv.innerHTML = '<div class="status success">‚úÖ Login successful!</div>';
          loadPosts();
        } else {
          statusDiv.innerHTML = '<div class="status error">‚ùå Invalid password. Access denied.</div>';
          authToken = null;
        }
      });
    }
    
    function logout() {
      authToken = null;
      localStorage.removeItem('gelora_admin_token');
      document.getElementById('login-screen').style.display = 'block';
      document.getElementById('main-cms').classList.add('hidden');
      document.getElementById('admin-password').value = '';
    }
    
    async function testAuth() {
      try {
        const response = await fetch('/api/posts', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            title: 'test',
            content: 'test'
          })
        });
        
        // If we get 401, auth failed. If we get 400 (validation error), auth worked
        return response.status !== 401;
      } catch (error) {
        return false;
      }
    }
    
    // Check if already logged in
    if (authToken) {
      testAuth().then(success => {
        if (success) {
          document.getElementById('login-screen').style.display = 'none';
          document.getElementById('main-cms').classList.remove('hidden');
        } else {
          logout();
        }
      });
    }

    // Tab Management
    function showTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
      });
      
      // Remove active from all buttons
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Show selected tab
      document.getElementById(tabName + '-tab').classList.remove('hidden');
      event.target.classList.add('active');
      
      // Load data for specific tabs
      if (tabName === 'posts') {
        loadPosts();
      }
    }

    // Load Posts
    async function loadPosts() {
      const statusDiv = document.getElementById('posts-status');
      const listDiv = document.getElementById('posts-list');
      
      statusDiv.innerHTML = '<div class="status info">Loading posts...</div>';
      
      try {
        const response = await fetch('/api/posts');
        if (response.ok) {
          const data = await response.json();
          const posts = data.posts || [];
          currentPosts = posts; // Store for editing
          
          if (posts.length === 0) {
            statusDiv.innerHTML = '<div class="status info">No posts found. Create your first post!</div>';
            listDiv.innerHTML = '';
            return;
          }
          
          statusDiv.innerHTML = `<div class="status success">Found ${posts.length} posts</div>`;
          
          listDiv.innerHTML = posts.map(post => `
            <div class="post-item">
              <div class="post-title">${post.title}</div>
              <div class="post-meta">
                üìÖ ${post.date} | üè∑Ô∏è ${post.tags.join(', ')} | üìù ${post.content.length} chars
              </div>
              <div class="post-summary">${post.summary}</div>
              <div style="margin-top: 10px;">
                <button class="btn" onclick="editPost('${post.slug}')">‚úèÔ∏è Edit</button>
                <button class="btn" onclick="deletePost('${post.slug}')" style="border-color: #ef4444; color: #ef4444;">üóëÔ∏è Delete</button>
              </div>
            </div>
          `).join('');
          
        } else {
          statusDiv.innerHTML = `<div class="status error">Failed to load posts: ${response.status} ${response.statusText}</div>`;
        }
      } catch (error) {
        statusDiv.innerHTML = `<div class="status error">Error: ${error.message}</div>`;
      }
    }

    // Create Post
    async function createPost(event) {
      event.preventDefault();
      
      const statusDiv = document.getElementById('create-status');
      const form = event.target;
      const formData = new FormData(form);
      
      const postData = {
        title: formData.get('title'),
        summary: formData.get('summary'),
        tags: formData.get('tags').split(',').map(tag => tag.trim()).filter(tag => tag),
        content: formData.get('content'),
        date: new Date().toISOString().split('T')[0]
      };
      
      statusDiv.innerHTML = '<div class="status info">Creating post...</div>';
      
      try {
        const response = await fetch('/api/posts', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(postData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
          statusDiv.innerHTML = `<div class="status success">‚úÖ Post created successfully! File: ${result.filename}</div>`;
          form.reset();
          document.getElementById('tags').value = 'ethereum'; // Reset to default
        } else {
          statusDiv.innerHTML = `<div class="status error">‚ùå Failed to create post: ${result.error}</div>`;
        }
      } catch (error) {
        statusDiv.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
      }
    }

    // Clear Form
    function clearForm() {
      document.getElementById('create-form').reset();
      document.getElementById('tags').value = 'ethereum';
      document.getElementById('create-status').innerHTML = '';
    }

    // Debug Tests
    async function runDebugTests() {
      const resultsDiv = document.getElementById('debug-results');
      resultsDiv.innerHTML = '<div class="status info">Running tests...</div>';
      
      const tests = [];
      
      // Test API
      try {
        const response = await fetch('/api/test');
        if (response.ok) {
          const data = await response.json();
          tests.push({
            name: 'API Test',
            status: 'success',
            message: 'API working',
            data: data
          });
        } else {
          tests.push({
            name: 'API Test',
            status: 'error',
            message: `API failed: ${response.status}`
          });
        }
      } catch (error) {
        tests.push({
          name: 'API Test',
          status: 'error',
          message: `API error: ${error.message}`
        });
      }
      
      // Test Posts API
      try {
        const response = await fetch('/api/posts');
        tests.push({
          name: 'Posts API',
          status: response.ok ? 'success' : 'error',
          message: response.ok ? 'Posts API working' : `Posts API failed: ${response.status}`
        });
      } catch (error) {
        tests.push({
          name: 'Posts API',
          status: 'error',
          message: `Posts API error: ${error.message}`
        });
      }
      
      // Display results
      resultsDiv.innerHTML = tests.map(test => `
        <div class="status ${test.status}">
          <strong>${test.name}:</strong> ${test.message}
          ${test.data ? `<pre style="margin-top: 10px; font-size: 0.8em;">${JSON.stringify(test.data, null, 2)}</pre>` : ''}
        </div>
      `).join('');
    }

    // Edit Post
    let currentPosts = [];

    async function editPost(slug) {
      const post = currentPosts.find(p => p.slug === slug);
      if (!post) {
        alert('Post not found');
        return;
      }

      // Fill edit form
      document.getElementById('edit-original-filename').value = slug + '.mdx';
      document.getElementById('edit-title').value = post.title;
      document.getElementById('edit-summary').value = post.summary;
      document.getElementById('edit-tags').value = post.tags.join(', ');
      document.getElementById('edit-date').value = post.date;
      document.getElementById('edit-content').value = post.content;

      // Show edit tab
      document.getElementById('edit-tab-button').style.display = 'inline-block';
      showTab('edit');
    }

    async function updatePost(event) {
      event.preventDefault();
      
      const statusDiv = document.getElementById('edit-status');
      const form = event.target;
      const formData = new FormData(form);
      
      const postData = {
        originalFilename: formData.get('originalFilename'),
        title: formData.get('title'),
        summary: formData.get('summary'),
        tags: formData.get('tags').split(',').map(tag => tag.trim()).filter(tag => tag),
        content: formData.get('content'),
        date: formData.get('date')
      };
      
      statusDiv.innerHTML = '<div class="status info">Updating post...</div>';
      
      try {
        const response = await fetch('/api/posts', {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(postData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
          statusDiv.innerHTML = `<div class="status success">‚úÖ Post updated successfully! File: ${result.filename}</div>`;
          
          // Refresh posts and go back to posts tab
          setTimeout(() => {
            showTab('posts');
            loadPosts();
          }, 2000);
        } else {
          statusDiv.innerHTML = `<div class="status error">‚ùå Failed to update post: ${result.error}</div>`;
        }
      } catch (error) {
        statusDiv.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
      }
    }

    function cancelEdit() {
      document.getElementById('edit-tab-button').style.display = 'none';
      showTab('posts');
    }

    async function deletePost(slug) {
      if (!confirm(`Are you sure you want to delete the post "${slug}"?`)) {
        return;
      }

      try {
        // For now, we'll show an info message since DELETE endpoint isn't implemented
        alert('Delete functionality will be implemented soon. For now, manually delete the file from data/blog/ folder.');
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadPosts();
    });
  </script>
</body>
</html>
